---
title: "Playoffs 2"
author: "Team 9"
date: "3/24/2021"
output: html_document
---

The primary goal of this project is to design models for prediction of three variables – Spread, Total, and OREB. Below you can find clear definitions of these three outcome variables. It is imperative that you follow these specifications. Your group will be making predictions of the three variables for all NBA games between April 10 and April 30, inclusively. Your predictions should be saved in the dataset called Predictions. Here you will find missing values where future predictions will be placed. This completed file should be submitted along with a paper summarizing your methodology. You will not only be graded by your methodology, but also by your predictive accuracy. The variables, Spread, Total, and OREB will all be evaluated by root mean squared error (RMSE). For each of the variables, the top 6 groups will get 3 points, the middle 6 groups will get 2 points, the bottom 5 groups will get 1 point. All three variables are numeric. If you don’t submit numeric predictions, you will get 0 points.

Spread=Home Points−Away Points
Total=Home Points+Away Points
OREB=Home OREB+Away OREB

Games = important information about every game in the NBA since 2004. I would advise only using a subset of the data from recent years.
Games_Details = contains player level data for the games.
Teams = links TEAM_ID to each team’s NICKNAME and CITY.

The data you are given involves basic box score information. Because of this, you are required to engineer new variables and use outside data. This is highly recommended to gain a competitive edge in the sports betting market. For the engineering of new variables, consider creating differences and ratios between the stats for the home and away teams. Also, it may be useful to create variables that represent past information such as moving averages or lagged variables. These are just two basic examples. For the use of outside data, explore research for what other variables could be important for predicting these three variables. If you take the time to get data from games in the 2021, this data will be considered outside data.


```{r}
#Install and Load RCurl Package
library(curl)
library(tidyverse)
```

```{r}
#Read Data Directly from Github
GAMES=read.csv(url("https://raw.githubusercontent.com/mattymo18/STOR-538-Project2-2021/master/Source-Data/games.csv"))
GAMES_DETAILS=read.csv(url("http://raw.githubusercontent.com/mattymo18/STOR-538-Project2-2021/master/Source-Data/games_details.csv"))
TEAMS=read.csv(url("https://raw.githubusercontent.com/mattymo18/STOR-538-Project2-2021/master/Source-Data/teams.csv"))
INJURIES=read.csv("injuries.csv")
```

```{r}
#Preview Datasets
head(GAMES)
head(GAMES_DETAILS)
```

```{r}
#Simplify Games Data

# total & spread: injuries, adjusted pm (whichever we import), home field advantage, chemistry scores???, pairwise four factors, previous game results
# oreb: avg height of starting lineup, predicted total shots (or points), injuries, previous game results (avg by team, then break down my team matchup; etc.)

# home field advantage + adjusted pm + chemistry scores for points and spread
    #could also use four factors as a linear model, or do model selection on a bunch of predictors
# player dependence for rebounds
    # back out total shots from total points and fg%'s to find total shots (could be a helpful predictor of rebounds) (or use fga between all players in games_details)


#my main concern is that our ideas so far could basically just predict a static metric for each team and then just add (total, oreb) or subtract (spread) based on opponent, with no real adjustment for matchups, etc.; could potentially create pairwise predictors that focus on features of the team rather than the games they were recorded for (e.g., player v player by position (pairwise average box stats) scaled by avg minutes played, pairwise simple rating from 82games)

SIMPLE_GAMES=GAMES %>%
    filter(between(SEASON,2010,2020)) %>%
    select(GAME_DATE_EST,GAME_ID,HOME_TEAM_ID,VISITOR_TEAM_ID,PTS_home,PTS_away) %>% 
    mutate(Spread=PTS_home-PTS_away,Total=PTS_home+PTS_away)
head(SIMPLE_GAMES)

# model selection --> cross validate --> next steps?
# oreb: height, total shots, predicted points? (higher coring means faster paced means more oreb)
# potentially use logistic to predict win or not, then use that to verify correctness of spread direction
```

```{r}
# Some Next Steps
SIMPLE_GAMES_2=GAMES %>%
    filter(between(SEASON,2010,2020)) %>%
    select(GAME_DATE_EST,GAME_ID,HOME_TEAM_ID,VISITOR_TEAM_ID,SEASON,PTS_home,PTS_away) %>% 
    mutate(Spread=PTS_home-PTS_away,Total=PTS_home+PTS_away,Home_Advantage="2.33")
SIMPLE_GAMES_2

FOURFACTORS=GAMES_DETAILS %>%
    select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,FGM,FG3M,FGA,TO,OREB,FTM,DREB) %>%
    group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
    summarize(FGM=sum(FGM,na.rm=T),FG3M=sum(FG3M,na.rm=T),FGA=sum(FGA,na.rm=T),
              TO=sum(TO,na.rm=T),
              OREB=sum(OREB,na.rm=T),
              FTM=sum(FTM,na.rm=T),
              DREB=sum(DREB,na.rm=T),
              .groups="drop") %>%
    mutate(EFG=((FGM+0.5*FG3M)/FGA),TPP=(TO/92),ORP=(OREB/(FGA-FGM)),FTR=(FTM/FGA),OEFG=NA,DTPP=NA,DRP=NA,OFTR=NA) %>%
    select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,EFG,TPP,ORP,FTR,OEFG,DTPP,DRP,OFTR)
FOURFACTORS

#need to merge similarly as done with oreb to get defensive four factors
```


```{r}
#Obtain Aggregated OREB from Player Level Statistics
OREB=GAMES_DETAILS %>%
    select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,OREB) %>%
    group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
    summarize(OREB=sum(OREB,na.rm=T),.groups="drop")
head(filter(OREB))
```

```{r}
#Merging Offensive Rebounds Into Game Data
SIMPLE_GAMES_OREB=left_join(SIMPLE_GAMES_2,select(OREB,-TEAM_ABBREVIATION),by=c("GAME_ID","HOME_TEAM_ID"="TEAM_ID")) %>%
    rename(OREB_home=OREB) %>%
    left_join(select(OREB,-TEAM_ABBREVIATION),by=c("GAME_ID","VISITOR_TEAM_ID"="TEAM_ID")) %>%
    rename(OREB_away=OREB) %>%
    mutate(OREB=OREB_home+OREB_away)
head(SIMPLE_GAMES_OREB)
```

```{r}
#Creating Home Team and Away Team Variables
ALL_TEAMS=TEAMS %>%
    select(TEAM_ID,CITY,NICKNAME) %>%
    unite(NAME,CITY,NICKNAME,sep=" ")
head(ALL_TEAMS)
```

```{r}
#Merging Team Name into original data
SIMPLE_GAMES_OREB_TEAM=left_join(SIMPLE_GAMES_OREB,ALL_TEAMS,by=c("HOME_TEAM_ID"="TEAM_ID")) %>%
    rename("Home Team"=NAME) %>%
    left_join(ALL_TEAMS,by=c("VISITOR_TEAM_ID"="TEAM_ID")) %>%
    rename("Away Team"=NAME) %>%
    select(GAME_DATE_EST,"Home Team","Away Team",everything())
    #select(-GAME_ID,-HOME_TEAM_ID,-VISITOR_TEAM_ID)
head(SIMPLE_GAMES_OREB_TEAM)
```

```{r}
#Making the Divisions Table
NAME<-c("Boston Celtics", "Brooklyn Nets", "New York Knicks", "Philadelphia 76ers", "Toronto Raptors", "Chicago Bulls", "Cleveland Cavaliers", "Detroit Pistons", "Indiana Pacers", "Milwaukee Bucks", "Atlanta Hawks", "Charlotte Hornets", "Miami Heat", "Orlando Magic", "Washington Wizards", "Denver Nuggets", "Minnesota Timberwolves", "Oklahoma City Thunder", "Portland Trail Blazers", "Utah Jazz", "Golden State Warriors", "Los Angeles Clippers", "Los Angeles Lakers", "Phoenix Suns", "Sacramento Kings", "Dallas Mavericks", "Houston Rockets", "Memphis Grizzlies", "New Orleans Pelicans", "San Antonio Spurs")
DIVISION<-c("Atlantic", "Atlantic", "Atlantic", "Atlantic", "Atlantic", "Central", "Central", "Central", "Central", "Central", "Southeast", "Southeast", "Southeast", "Southeast", "Southeast", "Northwest", "Northwest", "Northwest", "Northwest", "Northwest", "Pacific", "Pacific", "Pacific", "Pacific", "Pacific", "Southwest", "Southwest", "Southwest", "Southwest", "Southwest")
DIVISIONS<-data.frame(NAME,DIVISION)
```

```{r}
#Adding divisions to both TEAMS and SIMPLE_GAMES_OREB_TEAM
# URL : https://www.nba.com/teams
ALL_TEAMS_DIV=
    left_join(ALL_TEAMS,DIVISIONS,by=c("NAME"))
SIMPLE_GAMES_OREB_TEAM_DIV= 
    left_join(SIMPLE_GAMES_OREB_TEAM,ALL_TEAMS_DIV,by=c("Home Team"="NAME")) %>%
        rename("Home_Division"="DIVISION") %>%
        left_join(ALL_TEAMS_DIV,by=c("Away Team"="NAME")) %>%
        rename("Away_Division"="DIVISION") %>%
        select(-TEAM_ID.x,-TEAM_ID.y) %>%
        select(GAME_DATE_EST,`Home Team`,Home_Division,`Away Team`,Away_Division,everything())
head(SIMPLE_GAMES_OREB_TEAM_DIV)
```

```{r}
INJURIES
```

```{r}
INJURIESBYGAME=INJURIES %>%
    mutate(GAME_DATE_EST=format(strptime(as.character(Date),"%d/%m/%Y"),"%Y-%m-%d"),CA=ifelse(Acquired=="",0,1),CR=ifelse(Relinquished=="",0,1)) %>%
    select(GAME_DATE_EST,Team,CA,CR) %>%
    group_by(Team,GAME_DATE_EST) %>%
    summarize(SA=sum(CA),SR=sum(CR),.groups="drop")
INJURIESBYGAME

#join SA and SR to main data by game and team combo, then calculate rolling total for each (by season)
```


```{r}
PLAYERINFO=read.csv("all_seasons.csv")
PLAYERINFO
PLAYERINFO_2010_2020 = PLAYERINFO %>%
    filter(season=="2019-20"|season=="2018-19"|season=="2017-18"|season=="2016-17"|season=="2015-16"|season=="2014-15"|season=="2013-14"|season=="2012-13"|season=="2011-12"|season=="2010-11") %>%
    mutate(Season=as.integer(substr(season,1,4)))
PLAYERINFO_2010_2020
#age, height, weight, potentially more?
```

```{r}
#RAPM Data
RAPMDATA=read.csv("FOURFACTORSRAPM.csv")
RAPMDATASELECT_2010_2020=RAPMDATA %>%
    select(Player_Name=playerName,Season=season,RAPM=LA_RAPM) %>%
    mutate(Season=as.integer(substr(Season,1,4))) %>%
    arrange(Season,Player_Name) %>%
    filter(between(Season,2010,2020))
RAPMDATASELECT_2010_2020
```



```{r}
#Next Steps

#1. Create defensive four factor metrics, most recent ten games average (or overall games in 2020-2021) of offensive metrics as categorical predictor; if we can get defensive then subtract defensive from offensive and make these singular categorical predictors
#2. Add average height per team adjusted by minutes for latest starting lineup 
#3. Join SA and SR from INJURIESBYGAME to GAMES by GAME_DATE_EST for Home and Away teams, then calculate rolling total for each (by season)
#4. Figure out how we want to use the RAPM data (player matchups, team average, etc.) # pick starting lineup for a team from the last game in the data, weight by minutes
#5. Combine all data into one dataset called FINALDATA
#6. Begin predicting with various modeling techniques
```



```{r}
GAMES_DETAILS_SEASON_2010_2020=GAMES_DETAILS %>%
    left_join(select(GAMES,GAME_ID,SEASON),by="GAME_ID") %>%
    filter(between(SEASON,2010,2020))
GAMES_DETAILS_SEASON_2010_2020

str(GAMES_DETAILS_SEASON_2010_2020$SEASON)
str(RAPMDATASELECT_2010_2020$Season)
str(PLAYERINFO_2010_2020$Season)
str(GAMES$SEASON)
```


```{r}
GAMES_DETAILS
RAPMDATASELECT_2010_2020
PLAYERINFO_2010_2020


UPDATED_GAMES_DETAILS = GAMES_DETAILS_SEASON_2010_2020 %>%
    filter(!(START_POSITION=="")) %>%
    left_join(select(RAPMDATASELECT_2010_2020,Season,Player_Name,RAPM),by=c("SEASON"="Season","PLAYER_NAME"="Player_Name")) %>%
    left_join(select(PLAYERINFO_2010_2020,Season,player_name,player_height,player_weight,age),by=c("SEASON"="Season","PLAYER_NAME"="player_name")) %>%
    #mutate(Minutes=substr(MIN,1,2),Seconds=substr(MIN,4,5)) %>%
    group_by(SEASON,TEAM_ID) %>%
    summarize(Average_Starting_Height=mean(player_height,na.rm=T),
              Average_Starting_Weight=mean(player_weight,na.rm=T),
              Average_Starting_Age=mean(age,na.rm=T),
              Average_Starting_RAPM=mean(RAPM,na.rm=T),
              .groups="drop")

UPDATED_GAMES_DETAILS

#figure out how to account for 2020 season
```

```{r}
FOURFACTORS

FF_GAMES=GAMES %>%
    filter(between(SEASON,2010,2020)) %>%
    left_join(select(FOURFACTORS,GAME_ID,TEAM_ID,EFG,TPP,ORP,FTR),by=c("GAME_ID","HOME_TEAM_ID"="TEAM_ID")) %>%
    rename(EFG_home=EFG,TPP_home=TPP,ORP_home=ORP,FTR_home=FTR)
FF_GAMES

FOURFACTORS_BY_TEAM=FF_GAMES %>%
    group_by(SEASON,HOME_TEAM_ID) %>%
    summarize(EFG=mean(EFG_home),
              TPP=mean(TPP_home),
              ORP=mean(ORP_home),
              FTR=mean(FTR_home),
              .groups="drop")
FOURFACTORS_BY_TEAM
```

```{r}
#injuries, 
```


```{r}
FINAL_TEAM_DATA_2020=UPDATED_GAMES_DETAILS %>%
    left_join(select(FOURFACTORS_BY_TEAM,SEASON,HOME_TEAM_ID,EFG,TPP,ORP,FTR),by=c("SEASON","TEAM_ID"="HOME_TEAM_ID"))
FINAL_TEAM_DATA_2020

#take difference of four factor metrics between opponents to use as a predictor


#simple_games_2 as base data, left join final team data 2010-2020 onto it for both home and away team, division for home and away
```

```{r}
ALMOST_FINAL_DATA=SIMPLE_GAMES_OREB_TEAM_DIV %>%
    left_join(FINAL_TEAM_DATA_2020,by=c("SEASON","HOME_TEAM_ID"="TEAM_ID")) %>%
    rename(HASH=Average_Starting_Height,HASW=Average_Starting_Weight,HASA=Average_Starting_Age,HASR=Average_Starting_RAPM,HEFG=EFG,HTPP=TPP,HORP=ORP,HTFR=FTR) %>%
    left_join(FINAL_TEAM_DATA_2020,by=c("SEASON","VISITOR_TEAM_ID"="TEAM_ID")) %>%
    rename(VASH=Average_Starting_Height,VASW=Average_Starting_Weight,VASA=Average_Starting_Age,VASR=Average_Starting_RAPM,VEFG=EFG,VTPP=TPP,VORP=ORP,VTFR=FTR) %>%
    select(-GAME_ID,-HOME_TEAM_ID,-VISITOR_TEAM_ID)
ALMOST_FINAL_DATA
#write.csv(ALMOST_FINAL_DATA,'almost_final_data.csv')

#average rate of injuries by starting five each season
```

```{r}
#sub(".* ", "", ALMOST_FINAL_DATA$`Home Team`)
```


```{r}
ALMOST_FINAL_DATA_2=ALMOST_FINAL_DATA %>%
    mutate(Nickname=sub(".* ", "", ALMOST_FINAL_DATA$`Home Team`)) %>%
    left_join(select(INJURIESBYGAME,Team,SEASON,SR),by=c("Nickname"="Team","SEASON")) %>%
    rename(Nickname_Home=Nickname,Season_Injuries_Home=SR) %>%
    mutate(Nickname=sub(".* ", "", ALMOST_FINAL_DATA$`Away Team`)) %>%
    left_join(select(INJURIESBYGAME,Team,SEASON,SR),by=c("Nickname"="Team","SEASON")) %>%
    rename(Nickname_Away=Nickname,Season_Injuries_Away=SR) %>%
    select(-Nickname_Home,-Nickname_Away)
ALMOST_FINAL_DATA_2
```




```{r}
INJURIESBYGAME=INJURIES %>%
    mutate(GAME_DATE_EST=format(strptime(as.character(Date),"%d/%m/%Y"),"%Y-%m-%d"),SEASON=as.integer(substr(GAME_DATE_EST,1,4)),CA=ifelse(Acquired=="",0,1),CR=ifelse(Relinquished=="",0,1)) %>%
    select(GAME_DATE_EST,SEASON,Team,CA,CR) %>%
    group_by(Team,SEASON) %>%
    summarize(SA=sum(CA),SR=sum(CR),.groups="drop")
INJURIESBYGAME

#join SA and SR to main data by game and team combo, then calculate rolling total for each (by season)
```

















```{r}
FINAL_DATA_DRAFT=ALMOST_FINAL_DATA_2 %>%
    rename(Game_Date=GAME_DATE_EST,Home_Team=`Home Team`,Away_Team=`Away Team`,Season=SEASON,Points_Home=PTS_home,Points_Away=PTS_away,OReb_Home=OREB_home,OReb_Away=OREB_away,OReb=OREB,Average_Starting_Height_Home=HASH,Average_Starting_Weight_Home=HASW,Average_Starting_Age_Home=HASA,Average_Starting_Height_Away=VASH,Average_Starting_Weight_Away=VASW,Average_Starting_Age_Away=VASA,Average_Starting_RAPM_Home=HASR,Average_Starting_RAPM_Away=VASR,EFG_Home=HEFG,TPP_Home=HTPP,ORP_Home=HORP,TFR_Home=HTFR,EFG_Away=VEFG,TPP_Away=VTPP,ORP_Away=VORP,TFR_Away=VTFR,Injuries_Home=Season_Injuries_Home,Injuries_Away=Season_Injuries_Away)

FINAL_DATA_DRAFT
```

```{r}
FINAL_DATA<-FINAL_DATA_DRAFT[,c(1,6,2,3,4,5,7,8,9,10,12,13,14,31,32,11,15,16,17,23,24,25,18,26,19,20,21,22,27,28,29,30)]

FINAL_DATA

write.csv(FINAL_DATA,'final_data.csv')
```

